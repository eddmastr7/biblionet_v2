name: Django CI/CD - Ejecutar Pruebas

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest # Usar un sistema operativo Linux para la ejecución

    # Define las estrategias de prueba (ej. diferentes versiones de Python)
    strategy:
      max-parallel: 4
      matrix:
        python-version: ["3.10", "3.11"] # Prueba con versiones comunes
        django-version: ["4.2", "5.0"] # Ajusta según tu versión real de Django

    steps:
    - name: Checkout del repositorio
      uses: actions/checkout@v4

    - name: Configurar Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    # Asume que tienes un archivo requirements.txt con Django, etc.
    - name: Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        # Instalar Django específicamente para el entorno de prueba
        pip install "django~=${{ matrix.django-version }}"
        # Instalar librerías comunes de hashing (necesarias para make_password)
        pip install django-environ python-dotenv pillow
        pip install bcrypt argon2-cffi
        # NOTA: Si tus pruebas requieren MySQL, descomenta esta línea:
        # pip install mysqlclient 
        
    - name: Crear archivo settings de prueba (Final)
      run: |
        # Necesitas un settings.py básico para que Django sepa qué aplicación usar
        # y qué base de datos de prueba usar (usualmente sqlite3 por defecto)
        cat << EOF > test_settings.py
        import os
        SECRET_KEY = 'any_secret_key_for_testing'
        DEBUG = True
        ALLOWED_HOSTS = []
        DATABASES = {
            'default': {
                'ENGINE': 'django.db.backends.sqlite3',
                'NAME': os.path.join(os.getcwd(), 'test_db.sqlite3'),
            }
        }
        # ¡CORRECCIÓN DEFINITIVA! Usamos 'core.urls'
        ROOT_URLCONF = 'core.urls' 
        INSTALLED_APPS = [
            'django.contrib.admin',
            'django.contrib.auth',
            'django.contrib.contenttypes',
            'django.contrib.sessions',
            'django.contrib.messages',
            'django.contrib.staticfiles',
            'biblio', 
            'catalogo',
            'seguridad',
        ]
        MIDDLEWARE = [
            'django.middleware.security.SecurityMiddleware',
            'django.contrib.sessions.middleware.SessionMiddleware',
            'django.middleware.common.CommonMiddleware',
            'django.middleware.csrf.CsrfViewMiddleware',
            'django.contrib.auth.middleware.AuthenticationMiddleware',
            'django.contrib.messages.middleware.MessageMiddleware',
            'django.middleware.clickjacking.XFrameOptionsMiddleware',
        ]
        EOF
        
    - name: Ejecutar Pruebas de Django
      run: |
        # Ejecuta las pruebas usando el archivo de settings temporal
        python manage.py test biblio --settings=test_settings
        